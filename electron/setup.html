<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Required - BEIT Knowledge Base</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      color: #718096;
      font-size: 16px;
    }

    .status-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: #fed7d7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .status-icon.success {
      background: #c6f6d5;
    }

    .dependency-section {
      margin: 20px 0;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #fc8181;
    }

    .dependency-section.success {
      border-left-color: #48bb78;
      background: #f0fff4;
    }

    .dependency-section h3 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dependency-section p {
      color: #4a5568;
      margin: 10px 0;
      line-height: 1.6;
    }

    .instructions {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .instructions ol {
      margin-left: 20px;
      color: #2d3748;
    }

    .instructions li {
      margin: 8px 0;
      line-height: 1.5;
    }

    .code {
      background: #2d3748;
      color: #68d391;
      padding: 3px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 30px;
      justify-content: center;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-primary {
      background: #667eea;
      color: white;
    }

    .button-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button-secondary {
      background: #edf2f7;
      color: #4a5568;
    }

    .button-secondary:hover {
      background: #e2e8f0;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .hidden {
      display: none;
    }

    .link {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="status-icon" id="statusIcon">⚠️</div>
      <h1>Setup Required</h1>
      <p>Please install the following dependencies to use the BEIT Knowledge Base</p>
    </div>

    <div id="dependenciesContainer">
      <!-- Dependencies will be injected here -->
    </div>

    <div id="allGood" class="hidden">
      <div class="dependency-section success">
        <h3>✅ All dependencies are ready!</h3>
        <p>The application is starting...</p>
      </div>
    </div>

    <div class="button-group">
      <button id="recheckBtn" class="button button-primary" onclick="recheckDependencies()">
        <span id="recheckText">Check Again</span>
        <span id="recheckSpinner" class="spinner hidden"></span>
      </button>
      <button class="button button-secondary" onclick="openDocs()">
        Setup Guide
      </button>
    </div>
  </div>

  <script>
    // Check if we're in Electron
    const isElectron = window.electron !== undefined;

    async function recheckDependencies() {
      const btn = document.getElementById('recheckBtn');
      const text = document.getElementById('recheckText');
      const spinner = document.getElementById('recheckSpinner');

      // Show loading state
      text.classList.add('hidden');
      spinner.classList.remove('hidden');
      btn.disabled = true;

      try {
        if (isElectron) {
          const issues = await window.electron.checkDependencies();
          displayDependencies(issues);
        } else {
          alert('This page should only be accessed from the Electron app');
        }
      } catch (error) {
        console.error('Failed to check dependencies:', error);
        alert('Failed to check dependencies. Please try again.');
      } finally {
        // Reset button state
        text.classList.remove('hidden');
        spinner.classList.add('hidden');
        btn.disabled = false;
      }
    }

    function displayDependencies(issues) {
      const container = document.getElementById('dependenciesContainer');
      const statusIcon = document.getElementById('statusIcon');
      const allGood = document.getElementById('allGood');

      if (issues.length === 0) {
        // All good!
        container.innerHTML = '';
        allGood.classList.remove('hidden');
        statusIcon.textContent = '✅';
        statusIcon.classList.add('success');

        // Reload after 2 seconds
        setTimeout(() => {
          if (isElectron) {
            window.electron.restartServer();
          }
        }, 2000);
        return;
      }

      // Display issues
      allGood.classList.add('hidden');
      statusIcon.classList.remove('success');

      container.innerHTML = issues.map(issue => `
        <div class="dependency-section">
          <h3>❌ ${issue.name}</h3>
          <p>${issue.message}</p>
          <div class="instructions">
            <ol>
              ${issue.instructions.map(instruction => {
                // Replace "ollama pull" commands with code formatting
                const formatted = instruction.replace(
                  /ollama pull ([^\s]+)/g,
                  '<span class="code">ollama pull $1</span>'
                ).replace(
                  /pip install ([^\s]+)/g,
                  '<span class="code">pip install $1</span>'
                ).replace(
                  /start\.(bat|sh)/g,
                  '<span class="code">start.$1</span>'
                );
                return `<li>${formatted}</li>`;
              }).join('')}
            </ol>
          </div>
        </div>
      `).join('');
    }

    function openDocs() {
      // Open documentation in default browser
      const docsUrl = 'https://github.com/bilalghalib/beit-knowledge-base-offline#setup';
      if (isElectron) {
        require('electron').shell.openExternal(docsUrl);
      } else {
        window.open(docsUrl, '_blank');
      }
    }

    // Listen for dependency issues from main process
    if (isElectron && window.electron.onDependencyIssues) {
      window.electron.onDependencyIssues((issues) => {
        displayDependencies(issues);
      });
    }

    // Initial check on load
    window.addEventListener('DOMContentLoaded', () => {
      recheckDependencies();
    });
  </script>
</body>
</html>
